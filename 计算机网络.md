# 计算机网络详解
writer：wjm

由于现有的教学大纲都是按照物理层，链路层，网络层，传输层，应用层来教学
我们也是按照这种教学方法来介绍
## 物理层
### 基本概念
数据是指信息传送的实体
信号则是数据的电气或电磁表现，是数据在传输过程中的存在形式
数据和信号都存在模拟或数字之分
1. 模拟数据的取值是连续的
2. 数字数据的取值是离散的

在通信系统中，常使用一个固定时长的信号波形来表示一个K进制数，这个时长内的信号称为码元，而该时长称为码元宽度


#### 信源、信道、信宿
下图是一个单项通信系统的模型
![alt text](信道.png)
信源是产生和发送数据的源头，信宿是接收数据的终点，信道是信号的传输介质
note：一条双向通信的线路包含一个发送信号和一个接收信道
噪声源是信道上的噪声及分散在通信系统上其他各处的噪声的集中表示

基带传输：信道上直接未经过调制的原始电信号
宽带传输：信道上传输经过调制的信号

数据传输方式分为并行和串行
- 并行传输适合短距离传输，一般用于计算机内部
- 串行传输适合长距离传输

#### 奈奎斯特定理
在理想低通信道（无噪声，带宽有限），为了避免码间串扰，极限码元传输速率未2W波特
W为信号的频率带宽（HZ为单位），如果用V来表示每个码元的离散电平数量
那么有
$$
\text{理想低通信道的极限数据传输速率} = 2W\log _{2}V \; (\mathrm{b/s})
$$
上述公式其实就是将以码元为单位转为以b/s为单位

#### 香农定理
给出带宽受限且具有高斯噪声干扰的信道的极限数据传输速率

## 传输层
传输层作为计算机网络重要的层次，其存在两个重要的协议，分别为TCP和UDP，本节就来介绍他们
### 传输层提供的服务
提供端到端之间的通信，也就是主机进程和主机进程之间的通信
##### 复用和分用
复用指的是发送方不同的应用进程都可以使用同一个传输层协议传送数据，分用指的是接收方的传输层在剥去报文的首部后能够把这些数据正确交付。
##### 差错检验
传输层要对收到的报文进行差错检验，对于TCP要求重发，UDP直接丢弃

#### 传输层的寻址和端口
端口能让应用层的各种进程将其数据向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过㐰交付给应用层相应的进程

##### 端口号
应用进程通过端口号进行标识，一共可以标识65536个端口号
服务端常用的熟知端口号0~1023，另一种为登记端口号 1024~49151，供没有熟知端口号的应用程序使用的，需要登记
客户端端口号为49152~65535，动态选择

### UDP
##### UDP概述
1. 无需建立连接，不存在连接时延
2. 无连接状态
3. 首部开销小
4. 没有拥塞控制
5. 支持一对多通信
6. 发送方对于应用层交下来的报文，不合并也不拆分，原封不动的进行封装

##### UDP首部格式
UDP首部共8B，由四个字段组成
分别为 源端口，目的端口，长度，校验和

##### UDP校验
在计算UDP校验和的时候，要在UDP数据报前面加上12B的伪首部，伪首部不是真正的首部，而是计算校验和的时候，临时添加的
发送方：先将全0填入校验和字段，随后将伪首部和UDP数据包看作多个16位的子串连接起来的，若UDP数据部分不是偶数个字节，那么就需要在末尾填入一个全0字节（此字节不发送），然后按照二进制反码求和

接收方：将收到的UDP数据报和伪首部连接，补零，然后按照二进制反码求16位和，结果全1为正确
如果最高位产生进位：需要进行回卷

### TCP
##### TCP概述
1. TCP面向连接，是一条逻辑连接
2. 每个TCp只能存在两个端点，且每一条连接只能是一对一的
3. TCP提供可靠交付的服务
4. TCP提供全双工通信，为此TCP连接的两端都设有发送缓存和接收缓存
5. 面向流的，TCP把应用程序交下来的数据视为一连串的无结构的字节流

##### 粘包和拆包问题
上面的5说到，TCP连接时面向字节流的，从而没有消息边界的概念，所以就会出现粘包和拆包问题
粘包：接收方一次收到发送方发送的多个数据包的数据，这些数据在接收缓冲区粘在了一起
拆包：接收方收到的数据时发送方发送一个数据包的一部分，剩下的部分可能还在网络上传输
- 粘包问题的产生
在发送端，TCP为了优化网络效率，在发送端可能会使用合并算法（Nagle）算法，将多个小的数据包合并发送出去，导致粘包
接收方使用TCP接收到的数据先放入接收缓冲区，应用层调用recv从缓冲区读取数据，如果存在多个包积累，就会存在粘包现象

- 拆包现象
将一个大的数据包拆分成多个TCP报文段发送，这可能导致拆包
如果一个报的数据过大，超过了应用层指定的读取缓冲区大小或者超过了单个TCP段的大小，导致一次读取操作可能只读取了包的一部分

--- 

接下来谈谈如何解决这个问题
1. 消息长度字段
在每个数据包的开头，固定用一个字段来标识当前包的长度
2. 分隔符
在每个数据包的结尾加一个特定分隔符
3. 固定消息长度
每次发送和接收的大小都固定为一个常量

##### TCP报文段
一个TCP首部和数据两部分，首部最短为20B，最长为60B
这里介绍一下TCP首部的各个字段

1. 源端口和目的端口
2. 序号：TCP传送的数据流中每个字节都要按顺序编号
3. 确认号：期望收到下一个报文段的数据序号
4. 数据偏移（首部长度）：以4B为单位，指出首部长度
5. 保留位：保留为今后使用，目前置零
6. 紧急位：当期为1的时候，表名紧急指针字段有效，告诉系统此报文端中存在紧急数据，应该尽快传送
7. 确认位：为1的时候表示确认号有效
8. 推送位：为1的时候表示接收方需要尽快交付给接收应用进程，而不是等到缓存满了在进行交付
9. 复位位：为1的时候表示TCP连接出现严重差错，必须释放，然后重新建立连接
10. 同步位：为1的时候表示这是一个连接请求或者接收报文
11. 终止位：为1的时候表示此报文段的发送方的数据已经发送完毕，并要求释放连接
12. 窗口：占2B，告诉对方从确认号开始，还可以允许对方发送的数据量
13. 校验和：占2B
14. 紧急指针：占2B，指出本报文段中的紧急数据的字节数，紧急数据排在报文段最前面
15. 选项：长度可变，最长为40B
16. 填充：使首部为4B的整数倍

note：即使窗口为0，也可以发送紧急数据

##### TCP连接管理
- 三次握手：连接建立
![Alt text](三次握手.png)
note：在TCP连接中，SYN等于1的报文段不允许携带数据，同时第三次握手如果不携带数据，则不消耗序号

- 四次挥手：连接释放
![Alt text](四次挥手.png)
note:
FIN = 1字段不携带数据也要消耗一个序号，且FIN = 1，ACK = 0，即挥手是主动发送的
除了2MSL，我们在服务端还设置了一个保活计时器，用来避免客户机出现故障，而服务器一直无效等待，每收到一次客户的数据，就会重置这个计时器，如果计时器到期还没有收到客户的数据，服务器就会每隔75秒发送一个探测报文端，连续发送10次，如果还没收到回复，就认为客户机出现故障，关闭连接

##### TCP可靠传输

TCP靠什么保障可靠也是老生常谈的问题

1. 序号和确认号：note：TCP默认使用累积确认
2. 重传机制：超时和冗余ack

##### 这里介绍一下重传机制
1. 超时：TCP每发送一个报文端，就会对这个报文端设置一个超时计时器，如果重传时间到期还没收到确认，就重传这一报文段
这里注意：这个超时计时器是动态变化的，TCP使用的是自适应算法，维护了RTT的一个加权平均往返时间RTTS，根据新测量的RTT样本值的变化而变化。
2. 冗余ACK
TCP规定每当比期望序号大的失序报文段到达时,就发送一个冗余ACK,指明下一个期待字节的序号。
TCP规定当发送方收到对同一个报文段的3个冗余 ACK 时,就可以认为跟在这个被确认报文段之后的报文段已经丢失。

##### TCP流量控制
匹配发送方的发送速率和接收方的读取速率
TCP的接收方维护一个接收窗口，接收方根据接收缓存的大小动态调整接收窗口的大小，并将其置于接收窗口字段，发送给发送方
TCP 为每个连接设有一个持续计时器,只要发送方收到对方的零窗口通知,就启动持续计时器。若计时器超时,就发送一个零窗口探测报文段,而对方就在确认这个探测报文段时给出现在的窗口值。若窗口仍然为零,则发送方收到确认报文段后就重新设置持续计时器。

##### TCP拥塞控制

拥塞控制是为了防止过多的消息进入注入网络
TCP拥塞控制的算法一共有四种：慢开始，快重传，快恢复，拥塞避免
发送方维护一个拥塞窗口：大小取决于网络的拥塞程度
发送窗口的上限值=min[rwnd, cwnd]

1. 慢开始和拥塞避免
慢开始算法：指在 TCP 开始发送报文段时，先设置 cwnd=1,使得发送方一开始向网络注入的报文段少(目的是试探一下网络的拥塞情况),然后逐渐增大 cwnd,这对防止网络出现拥塞是一个非常有力的措.施
这样，每次经过一个RTT之后，cwnd就会加倍，指数增长，同时还设置一个慢开始门限ssthresh，当慢开始将cwnd增加到ssthresh后，改用拥塞避免算法

拥塞避免：具体做法是:每经过一个往返时延 RTT 就把发送方的拥塞窗口 cwnd 加 1

网络拥塞的处理
无论在慢开始阶段还是在拥塞避免阶段,只要发送方判断网络出现拥塞(未按时收到确认),就要首先把慢开始门限 ssthresh 设置为出现拥塞时的发送方的 cwnd 值的一半(但不能小于2),然后把拥塞窗口 cwnd 重新设置为1,执行慢开始算法。

note:在慢开始阶段,若2cwnd > ssthresh,则下一个RTT后的cwnd 等于 ssthresh,而不等于2cwnd。

2. 快重传与快恢复

快重传：接收方不要等待自己发送数据时才进行捐带确认,而要立即发送确认,即使收到了失序的报文段也要立即发出对已收到报文段的重复确认。

快恢复：:当发送方连续收到3个冗余 ACK(重复确认)时,执行“乘法减小”方法,把慢开始门限 ssthresh 调整为当前 cwnd 的一半。

##### 为什么握手是三次，挥手是四次
对于为什么是三次握手：

两次握手情况下：我们假设这样一种场景，由于网络阻塞，客户端发送的一个请求连接没有到达，客户端发送了第二个连接请求，此时第一个请求到达，服务器返回，并且认为自己同客户端建立了连接，但是这个回复到达客户端的时候，由于客户端已经发送了新的连接就会丢弃，然后如果第二个请求到达，服务器以为这个是新的连接，就再次返回，此时客户端收到后建立连接，但是这样就造成服务端多了一个连接，所以我们采用三次握手，如果客户端丢弃了这个回复，那么服务端就会因为超时释放那个连接

同时第三次握手使得服务端知道客户端同步了自己的序号

对于为什么是四次挥手：这个理由就很多了

全双工需要双向独立关闭

被动关闭方需要处理遗留数据

主动关闭方需要确认对方的 FIN

TIME-WAIT 状态的作用

可靠地终止最后一个 ACK：确保被动关闭方能够成功收到第四次挥手的ACK

消除旧连接报文干扰：使得此时网络中属于这个连接的报文全部过期

## 其他（考研同学可以看看这些注意事项）

### URL
URL（统一资源定位符）的标准格式为"协议://域名[:端口]/路径"。

### 计算机网络分类
A类：0-127 =>以0开头
B类：128-191 =》以10开头
C类：192-223 =》以110开头

### 网络攻击
DNS攻击：攻击者攻击了域名解析服务器，修改了其中IP和域名的对应关系，使得用户输入域名时候，会进入到错误的网站上去，攻击者可以截获信息
DOS攻击：DOS攻击是指攻击者发送大量请求使得正常用户的请求无法到达，或者是攻击者在某一个时间发送大量数据给服务器，造成服务器瘫痪两种方式 
MAC地址欺骗：使局域网内主机无妨访问局域网，通过修改交换机端口和MAC地址的映射关系

### 网络中的长度
- MAC长度为6字节，48bits
- 端口号长度为2B，能够标识65536个不同的端口号
- UDP首部 ：8B
- TCP首部序号确认号：4B

### 常用端口号
FTP 21
TELNET 23
SMTP 25
DNS 53
TFTP 69
HTTP 80
SNMP 161
MYsql 3306
HTTPS 443


### 速度
存储设备的访问速度排序为:CPU高速缓存 > RAM > ROM > SSD > 磁盘。磁盘由于涉及机械运动,访问速度最慢。而CPU的高速缓存通常使用静态RAM(SRAM)构成,以获得最快的访问速度。

### BGP


# 参考文献
- 王道计算机网络
